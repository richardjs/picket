#include "board.h"
#include <stdio.h>

#define bitscan(x) __builtin_ctzl(x)

const bitboard MOVES[2][64] = {{
	0b0000000000000000000000000000000000000000000000000000001100000000,
	0b0000000000000000000000000000000000000000000000000000011100000000,
	0b0000000000000000000000000000000000000000000000000000111000000000,
	0b0000000000000000000000000000000000000000000000000001110000000000,
	0b0000000000000000000000000000000000000000000000000011100000000000,
	0b0000000000000000000000000000000000000000000000000111000000000000,
	0b0000000000000000000000000000000000000000000000001110000000000000,
	0b0000000000000000000000000000000000000000000000001100000000000000,
	0b0000000000000000000000000000000000000000000000110000000000000000,
	0b0000000000000000000000000000000000000000000001110000000000000000,
	0b0000000000000000000000000000000000000000000011100000000000000000,
	0b0000000000000000000000000000000000000000000111000000000000000000,
	0b0000000000000000000000000000000000000000001110000000000000000000,
	0b0000000000000000000000000000000000000000011100000000000000000000,
	0b0000000000000000000000000000000000000000111000000000000000000000,
	0b0000000000000000000000000000000000000000110000000000000000000000,
	0b0000000000000000000000000000000000000011000000000000000000000000,
	0b0000000000000000000000000000000000000111000000000000000000000000,
	0b0000000000000000000000000000000000001110000000000000000000000000,
	0b0000000000000000000000000000000000011100000000000000000000000000,
	0b0000000000000000000000000000000000111000000000000000000000000000,
	0b0000000000000000000000000000000001110000000000000000000000000000,
	0b0000000000000000000000000000000011100000000000000000000000000000,
	0b0000000000000000000000000000000011000000000000000000000000000000,
	0b0000000000000000000000000000001100000000000000000000000000000000,
	0b0000000000000000000000000000011100000000000000000000000000000000,
	0b0000000000000000000000000000111000000000000000000000000000000000,
	0b0000000000000000000000000001110000000000000000000000000000000000,
	0b0000000000000000000000000011100000000000000000000000000000000000,
	0b0000000000000000000000000111000000000000000000000000000000000000,
	0b0000000000000000000000001110000000000000000000000000000000000000,
	0b0000000000000000000000001100000000000000000000000000000000000000,
	0b0000000000000000000000110000000000000000000000000000000000000000,
	0b0000000000000000000001110000000000000000000000000000000000000000,
	0b0000000000000000000011100000000000000000000000000000000000000000,
	0b0000000000000000000111000000000000000000000000000000000000000000,
	0b0000000000000000001110000000000000000000000000000000000000000000,
	0b0000000000000000011100000000000000000000000000000000000000000000,
	0b0000000000000000111000000000000000000000000000000000000000000000,
	0b0000000000000000110000000000000000000000000000000000000000000000,
	0b0000000000000011000000000000000000000000000000000000000000000000,
	0b0000000000000111000000000000000000000000000000000000000000000000,
	0b0000000000001110000000000000000000000000000000000000000000000000,
	0b0000000000011100000000000000000000000000000000000000000000000000,
	0b0000000000111000000000000000000000000000000000000000000000000000,
	0b0000000001110000000000000000000000000000000000000000000000000000,
	0b0000000011100000000000000000000000000000000000000000000000000000,
	0b0000000011000000000000000000000000000000000000000000000000000000,
	0b0000001100000000000000000000000000000000000000000000000000000000,
	0b0000011100000000000000000000000000000000000000000000000000000000,
	0b0000111000000000000000000000000000000000000000000000000000000000,
	0b0001110000000000000000000000000000000000000000000000000000000000,
	0b0011100000000000000000000000000000000000000000000000000000000000,
	0b0111000000000000000000000000000000000000000000000000000000000000,
	0b1110000000000000000000000000000000000000000000000000000000000000,
	0b1100000000000000000000000000000000000000000000000000000000000000,
	0b0000000000000000000000000000000000000000000000000000000000000000,
	0b0000000000000000000000000000000000000000000000000000000000000000,
	0b0000000000000000000000000000000000000000000000000000000000000000,
	0b0000000000000000000000000000000000000000000000000000000000000000,
	0b0000000000000000000000000000000000000000000000000000000000000000,
	0b0000000000000000000000000000000000000000000000000000000000000000,
	0b0000000000000000000000000000000000000000000000000000000000000000,
	0b0000000000000000000000000000000000000000000000000000000000000000
}, {
	0b0000000000000000000000000000000000000000000000000000000000000000,
	0b0000000000000000000000000000000000000000000000000000000000000000,
	0b0000000000000000000000000000000000000000000000000000000000000000,
	0b0000000000000000000000000000000000000000000000000000000000000000,
	0b0000000000000000000000000000000000000000000000000000000000000000,
	0b0000000000000000000000000000000000000000000000000000000000000000,
	0b0000000000000000000000000000000000000000000000000000000000000000,
	0b0000000000000000000000000000000000000000000000000000000000000000,
	0b0000000000000000000000000000000000000000000000000000000000000011,
	0b0000000000000000000000000000000000000000000000000000000000000111,
	0b0000000000000000000000000000000000000000000000000000000000001110,
	0b0000000000000000000000000000000000000000000000000000000000011100,
	0b0000000000000000000000000000000000000000000000000000000000111000,
	0b0000000000000000000000000000000000000000000000000000000001110000,
	0b0000000000000000000000000000000000000000000000000000000011100000,
	0b0000000000000000000000000000000000000000000000000000000011000000,
	0b0000000000000000000000000000000000000000000000000000001100000000,
	0b0000000000000000000000000000000000000000000000000000011100000000,
	0b0000000000000000000000000000000000000000000000000000111000000000,
	0b0000000000000000000000000000000000000000000000000001110000000000,
	0b0000000000000000000000000000000000000000000000000011100000000000,
	0b0000000000000000000000000000000000000000000000000111000000000000,
	0b0000000000000000000000000000000000000000000000001110000000000000,
	0b0000000000000000000000000000000000000000000000001100000000000000,
	0b0000000000000000000000000000000000000000000000110000000000000000,
	0b0000000000000000000000000000000000000000000001110000000000000000,
	0b0000000000000000000000000000000000000000000011100000000000000000,
	0b0000000000000000000000000000000000000000000111000000000000000000,
	0b0000000000000000000000000000000000000000001110000000000000000000,
	0b0000000000000000000000000000000000000000011100000000000000000000,
	0b0000000000000000000000000000000000000000111000000000000000000000,
	0b0000000000000000000000000000000000000000110000000000000000000000,
	0b0000000000000000000000000000000000000011000000000000000000000000,
	0b0000000000000000000000000000000000000111000000000000000000000000,
	0b0000000000000000000000000000000000001110000000000000000000000000,
	0b0000000000000000000000000000000000011100000000000000000000000000,
	0b0000000000000000000000000000000000111000000000000000000000000000,
	0b0000000000000000000000000000000001110000000000000000000000000000,
	0b0000000000000000000000000000000011100000000000000000000000000000,
	0b0000000000000000000000000000000011000000000000000000000000000000,
	0b0000000000000000000000000000001100000000000000000000000000000000,
	0b0000000000000000000000000000011100000000000000000000000000000000,
	0b0000000000000000000000000000111000000000000000000000000000000000,
	0b0000000000000000000000000001110000000000000000000000000000000000,
	0b0000000000000000000000000011100000000000000000000000000000000000,
	0b0000000000000000000000000111000000000000000000000000000000000000,
	0b0000000000000000000000001110000000000000000000000000000000000000,
	0b0000000000000000000000001100000000000000000000000000000000000000,
	0b0000000000000000000000110000000000000000000000000000000000000000,
	0b0000000000000000000001110000000000000000000000000000000000000000,
	0b0000000000000000000011100000000000000000000000000000000000000000,
	0b0000000000000000000111000000000000000000000000000000000000000000,
	0b0000000000000000001110000000000000000000000000000000000000000000,
	0b0000000000000000011100000000000000000000000000000000000000000000,
	0b0000000000000000111000000000000000000000000000000000000000000000,
	0b0000000000000000110000000000000000000000000000000000000000000000,
	0b0000000000000011000000000000000000000000000000000000000000000000,
	0b0000000000000111000000000000000000000000000000000000000000000000,
	0b0000000000001110000000000000000000000000000000000000000000000000,
	0b0000000000011100000000000000000000000000000000000000000000000000,
	0b0000000000111000000000000000000000000000000000000000000000000000,
	0b0000000001110000000000000000000000000000000000000000000000000000,
	0b0000000011100000000000000000000000000000000000000000000000000000,
	0b0000000011000000000000000000000000000000000000000000000000000000
}};

void Board_init(struct Board *board){
	board->bits[WHITE] = 0b1111111111111111ul;
	board->bits[BLACK] = (0b1111111111111111ul << 48);
	board->turn = WHITE;
}

int Board_moves(const struct Board *board, struct Board boards[]){
	enum Color turn = board->turn;
	bitboard pieces = board->bits[turn];
	bitboard openSpaces = ~(board->bits[WHITE] | board->bits[BLACK]);

	int count = 0;
	while(pieces > 0){
		bitboard piece = bitscan(pieces);
		pieces ^= (1ul << piece);

		bitboard moves = MOVES[turn][piece];
		moves &= openSpaces;

		while(moves > 0){
			bitboard move = bitscan(moves);
			moves ^= (1ul << move);

			struct Board *child = &boards[count++];
			child->bits[turn] = board->bits[turn];
			child->bits[turn] ^= (1ul << piece);
			child->bits[turn] |= (1ul << move);
			child->bits[!turn] = board->bits[!turn];
			child->turn = !board->turn;
		}
	}

	return count;
}

void Board_print(const struct Board *board){
	printf("----------------\n");
	for(int y = 7; y >= 0; y--){
		for(int x = 0; x < 8; x++){
			bitboard space = 1ul << (y*8 + x);
			char c;
			if((board->bits[WHITE] & space) && !(board->bits[BLACK] & space)){
				c = 'W';
			}else if(!(board->bits[WHITE] & space) && (board->bits[BLACK] & space)){
				c = 'B';
			}else if((board->bits[WHITE] & space) && (board->bits[BLACK] & space)){
				c = '!';
			}else{
				c = '-';
			}
			putchar(c);
			if(x != 7){
				putchar(' ');
			}
		}
		if(board->turn == WHITE && y == 0){
			printf("  T");
		}else if(board->turn == BLACK && y == 7){
			printf("  T");
		}
		putchar('\n');
	}
	printf("----------------\n");
}
